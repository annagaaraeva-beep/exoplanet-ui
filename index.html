<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ExoDetect — Exoplanet Analysis Interface</title>
  <meta name="description" content="Web interface for loading exoplanet data and sending it to an AI/ML service for identification">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#7c3aed;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022 0%,#071126 60%);color:#e6eef6}
    .container{max-width:1100px;margin:32px auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{color:var(--muted);margin:6px 0 0;font-size:13px}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}

    .upload-area{border:2px dashed rgba(255,255,255,0.04);padding:18px;border-radius:10px;text-align:center;transition:all .15s}
    .upload-area.dragover{border-color:rgba(124,58,237,0.9);transform:translateY(-4px)}
    .btn{display:inline-block;padding:8px 14px;border-radius:8px;background:var(--accent);color:white;text-decoration:none;font-weight:600;margin-top:8px;border:none;cursor:pointer}
    input[type=file]{display:none}

    .meta{font-size:13px;color:var(--muted);margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.02)}

    .log{height:170px;overflow:auto;background:var(--glass);padding:10px;border-radius:8px;font-family:monospace;font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    #chartScatter {
      width: 100% !important;
      max-height: 300px;
    }
    #resultArea {
    max-height: 450px;
    padding: 10px;
    background: rgba(255,255,255,0.01);
    border-radius: 8px;
    color: var(--muted);
    font-family: monospace;
    white-space: pre-wrap;
    overflow-y: auto; 
    }

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <p class="lead">Upload datasets (CSV/JSON), preview, visualize, and send to the model (via API).</p>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>1) Upload Data</h3>
        <div id="drop" class="upload-area">
          <p style="margin:8px 0">Drag & Drop CSV or JSON here, or</p>
          <label class="btn" for="file">Choose a File</label>
          <input id="file" type="file" accept=".csv,application/json,text/csv" />
          <div class="meta">Supported formats: CSV (recommended), JSON.</div>
        </div>

        <div style="margin-top:12px" class="actions">
          <button id="loadSample" class="btn">Load Sample</button>
          <button id="clear" class="btn">Clear</button>
        </div>

        <h3 style="margin-top:14px">2) Preview</h3>
        <div id="preview" style="max-height:260px;overflow:auto"></div>

        <h3 style="margin-top:12px">3) Send for Analysis</h3>
        <div class="actions">
          <button id="analyze" class="btn">Send to Model</button>
        </div>

        <div style="margin-top:10px">
          <div class="log" id="log">Log events...
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Visualizations & Results</h3>
        <canvas id="chartScatter"></canvas>
        <h4 style="margin-top:12px">Identification Results</h4>
        <div id="resultArea" style="min-height:110px;padding:10px;background:rgba(255,255,255,0.01);border-radius:8px;color:var(--muted);font-family:monospace;white-space:pre-wrap;">
          <pre id="resultsText">Results from the model will appear here.</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const log = (s)=>{const l=$('log'); l.textContent = (new Date()).toLocaleTimeString()+ ' — ' + s + '\n' + l.textContent}

    function parseCSV(text){
      const rows = text.trim().split(/\r?\n/).filter(r=>r.trim()!=="");
      if(!rows.length) return [];
      const headers = rows[0].split(/,|;|\t/)
        .map(h=>h.trim().replace(/^\uFEFF/, '').toLowerCase()); // 🔹 прибираємо BOM і знижуємо регістр

    const data = rows.slice(1).map(r=>{
      const cols = r.split(/,|;|\t/);
      const obj = {};
      headers.forEach((h,i)=>obj[h]=cols[i]!==undefined?cols[i].trim():"");
      return obj;
    });
    return data;
  }


    let currentData = [];
    let scatterChart = null;
    let onnxSession = null; 

    $('file').addEventListener('change',e=>{if(e.target.files[0]) handleFile(e.target.files[0])});

    async function handleFile(file){
      log('File received:' + file.name);
      const txt = await file.text();
      let parsed = [];
      if(file.type.includes('json') || file.name.toLowerCase().endsWith('.json')){
        try{ parsed = JSON.parse(txt); if(!Array.isArray(parsed)) parsed = [parsed]; }
        catch(err){ log('JSON Error: '+err.message); alert('Invalid JSON'); return }
      } else {
        parsed = parseCSV(txt);
      }
      currentData = parsed;
      renderPreview(parsed);
      renderChart(parsed);
    }

    function renderPreview(data){
      const p = $('preview'); 
      p.innerHTML='';
      if(!data || data.length===0){ 
          p.textContent='No data available'; 
          return 
      }
      
      const keys = Object.keys(data[0]).filter(k => k !== 'disp');
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>' + keys.map(k=>`<th>${k}</th>`).join('') + '</tr>';
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.slice(0,30).forEach(row=>{
          const tr = document.createElement('tr');
          keys.forEach(k=>{
            const td = document.createElement('td');
            td.textContent = row[k] ?? '';
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      p.appendChild(table);
    }

    function renderChart(data){
      const ctx = document.getElementById('chartScatter').getContext('2d');
      if(scatterChart){ scatterChart.destroy(); }

      const points = data
        .map(d => ({
          x: parseFloat(d.orbper ?? d.pl_orbper) || null,
          y: parseFloat(d.rad ?? d.pl_rade) || null,
          label: d.pl_name ?? d.name ?? ''
        }))
        .filter(p => p.x !== null && p.y !== null);

      if(points.length === 0){ return; }

      scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Orbital period (days) vs Radius (R⊕)',
            data: points,
            backgroundColor: 'rgba(124,58,237,0.7)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.raw.label}: ${ctx.raw.x} d, ${ctx.raw.y} R⊕`
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'Orbital period (days)' } },
            y: { title: { display: true, text: 'Radius (R⊕)' } }
          }
        }
      });
    }

    $('loadSample').addEventListener('click',()=>{
      const sample = `pl_name,pl_orbper,pl_rade,pl_bmasse,disc_year,st_teff,st_rad,st_mass\nKepler-186f,129.9,1.11,1.1,2014,3788,0.47,0.54\nHD 209458 b,3.524,1.36,220,1999,6065,1.2,1.15`;
      currentData = parseCSV(sample);
      renderPreview(currentData);
      renderChart(currentData);
      log('Sample data loaded');
    });

    $('clear').addEventListener('click',()=>{
      currentData=[];
      $('preview').innerHTML='';
      if(scatterChart) scatterChart.destroy();
      $('resultArea').textContent='Results from the model will appear here.';
      log('Data cleared')
    });

    async function runModel(sample) {
      if (!onnxSession) {
        try {
          onnxSession = await ort.InferenceSession.create("model_xgb_final.onnx"); 
          log('ONNX session created successfully');
        } catch (err) {
          log('ONNX session creation error: ' + err.message);
          throw err;
        }
      }
      
      const tensor = new ort.Tensor("float32", Float32Array.from(sample), [1, sample.length]);
      const feeds = { input: tensor }; 
      
      const results = await onnxSession.run(feeds);
      
      console.log("Probabilities:", results['probabilities'].data);
      console.log("Class:", results['label'].data);
      
      return {
        probabilities: results['probabilities'].data,
        label: results['label'].data[0] 
      };
    }

    $('analyze').addEventListener('click', async ()=>{

  if (!currentData || currentData.length === 0) { 
    alert('No data available for analysis'); 
    return; 
  }

  try {
    log('Starting local analysis with ONNX...');
    const allResults = [];

    const featureNames = [ 'ra', 'dec', 'orbper', 'duration', 'depth', 'rad', 'steff', 'logg', 'srad'];

    for (const row of currentData) {
      const sample = featureNames.map(f => {
        const val = parseFloat(row[f]);
        return isNaN(val) ? 0 : val;
      });
      
      if (sample.length !==9) {
        continue;
      }
      const result = await runModel(sample);

      const prediction = result.label === 0n ? "This is not an exoplanet" : "This is an exoplanet";

      let output = "Information:\n";
      featureNames.forEach((f, i) => {
        output += `${f.padEnd(10)} ${sample[i]}\n`;
      });
      output += `\n${prediction}\n`;
      output += `Class: ${result.label}\n`;
      output += "--------------------------------------------------\n";

      allResults.push(output);
    }

    log('Analysis finished');
    resultsText.textContent = allResults.join('');

  } catch (err) { 
    log('Analysis error: ' + err.message); 
    alert('Analysis error: ' + err.message); 
  }
});


    log('Interface is ready. You can upload a dataset.');
  </script>
</body>
</html>
